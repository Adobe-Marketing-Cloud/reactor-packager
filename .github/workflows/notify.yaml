name: CI notify

# Only trigger, when the build workflow succeeded
on:
  workflow_run:
    workflows: ["ci"]
    types:
      - completed

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Get latest tag
        uses: oprypin/find-latest-tag@v1
        with:
          repository: octokit/rest.js  # The repository to scan.
          releases-only: true  # We know that all relevant tags have a GitHub release for them.
        id: repoTag  # The step ID to refer to later.
      - name: Notify Slack of Release
        uses: tokorom/action-slack-incoming-webhook@v1
        env:
         INCOMING_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
         text: "A new version of ${{ GITHUB_REPOSITORY }}${{ steps.repoTag.outputs.tag }} has been released"
         attachments: |
           [
             {
               "color": "good",
               "author_name": "${{ github.actor }}",
               "author_icon": "${{ github.event.sender.avatar_url }}",
               "fields": [
                 {
                   "title": "Compare URL",
                   "value": "${{ github.event.compare }}"
                 }
               ]
             }
           ]
